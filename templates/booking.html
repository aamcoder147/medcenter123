<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>حجز موعد - دكتور {{ doctor.name | default('N/A') }}</title> {/* Corrected Title Translation */}
    <!-- Fonts from Index -->
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet"> {/* ADDED CAIRO FONT FOR ARABIC */}
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- FingerprintJS -->
    <script src="https://cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs@3/dist/fp.min.js" defer></script>

    <style>
        /* --- Adopted :root from index.html --- */
        :root {
            /* --- Refined Clinical Palette --- */
            --bg-primary: #ffffff;
            --bg-secondary: #f9fafb; /* Very light grey - Main body background */
            --bg-accent-light: #e0f2f2;
            --bg-accent-very-light: #f0fafa;

            --border-color: #e5e7eb; /* Softer grey border */
            --border-color-strong: #d1d5db;
            --border-color-focus: var(--accent-primary); /* Use primary color for focus */

            --text-dark: #1f2937;
            --text-medium: #4b5563;
            --text-light: #ffffff;

            /* Primary Accent (Calm Blue/Teal) */
            --accent-primary: #007A7A;
            --accent-primary-dark: #005F5F;
            --accent-primary-light: #4DB6AC;

            /* Secondary / Warm Accent */
            --accent-warm: #F2A900;      /* Gold for stars */
            --accent-warm-dark: #D99700; /* Darker gold */

            --success: #10b981;
            --error: #ef4444;
            --info: #3b82f6;

            --shadow-color: rgba(0, 76, 76, 0.08);
            --shadow-color-medium: rgba(0, 76, 76, 0.12);
            --shadow-color-strong: rgba(0, 76, 76, 0.18);

            /* --- Timings & Transitions --- */
            --transition-speed: 0.3s;
            --transition-ease: ease-in-out;

            /* --- Adjusted variables for booking context --- */
            --accent-selected: var(--accent-primary-dark); /* Darker for selection */
            --accent-selected-text: var(--text-light);
            --accent-disabled-bg: #e5e7eb; /* Softer disabled bg */
            --accent-disabled-text: #9ca3af; /* Softer disabled text */
            --accent-disabled-border: #d1d5db;

            /* FONT FAMILY */
            --font-primary: 'Cairo', 'Open Sans', sans-serif; /* ADDED Cairo */
            --font-secondary: 'Lato', sans-serif;
        }

        html { scroll-behavior: smooth; }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background-color: var(--bg-secondary); color: var(--text-dark);
            /* font-family: 'Open Sans', sans-serif;  USE VARIABLE */
            font-family: var(--font-primary); /* USE VARIABLE */
            line-height: 1.7; overflow-x: hidden;
             -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; font-size: 16px;
        }

        /* --- Page Header --- */
        .page-top-bar {
            display: flex; justify-content: space-between; align-items: center;
            padding: 1rem 5%; background: var(--bg-primary); position: sticky; top: 0; z-index: 1000;
            border-bottom: 1px solid var(--border-color); box-shadow: 0 3px 8px var(--shadow-color);
        }
        /* Updated Font */
        .page-top-bar h1 { font-size: 1.6rem; font-weight: 700; color: var(--text-dark); font-family: var(--font-secondary); margin: 0; line-height: 1.3; }
        .page-top-bar h1 span { color: var(--accent-primary); }
        .back-button { /* Adopted button style */
             padding: 0.7rem 1.2rem; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9rem; text-align: center;
             transition: all var(--transition-speed) var(--transition-ease); border: 1px solid var(--border-color); text-decoration: none;
             display: inline-flex; align-items: center; justify-content: center; gap: 0.6rem; line-height: 1.2;
             background-color: var(--bg-secondary); color: var(--accent-primary); box-shadow: none;
        }
        .back-button:hover { background-color: var(--bg-accent-very-light); border-color: var(--accent-primary-light); color: var(--accent-primary-dark); transform: translateY(-1px); box-shadow: 0 2px 4px var(--shadow-color); }
        .back-button i { font-size: 0.9em; margin-right: 0.2rem; }

        /* --- Main Content Area --- */
        main { width: 90%; max-width: 1280px; margin: 2.5rem auto; padding: 0 1rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); gap: 2.5rem; align-items: start; }

        /* --- General Section Styling --- */
        .info-section, .form-section-wrapper, .reviews-section { background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 8px; padding: 2rem; box-shadow: 0 4px 10px var(--shadow-color); margin-bottom: 2rem; }

        /* --- Consistent Headings --- */
        h2, h3 { font-family: var(--font-secondary); color: var(--text-dark); margin-bottom: 1.2rem; font-weight: 700; position: relative; padding-bottom: 0.6rem; border-bottom: 1px solid var(--border-color); }
        h2::after, h3::after { content: ''; position: absolute; bottom: -1px; left: 0; width: 50px; height: 3px; background-color: var(--accent-primary); border-radius: 1.5px; }
        h2 { font-size: 1.7rem; } h3 { font-size: 1.4rem; }

        /* --- Doctor Info Section --- */
        .doctor-profile-header { display: flex; gap: 1.8rem; align-items: center; margin-bottom: 1.8rem; flex-wrap: wrap; }
        .doctor-photo-large-container { width: 150px; height: 150px; border-radius: 50%; overflow: hidden; border: 4px solid var(--bg-primary); box-shadow: 0 4px 12px rgba(0, 76, 76, 0.15); flex-shrink: 0; }
        .doctor-photo-large { width: 100%; height: 100%; object-fit: cover; display: block; }
        .doctor-name-spec h2 { border-bottom: none; padding-bottom: 0; margin-bottom: 0.3rem; font-size: 1.8rem; font-family: var(--font-secondary); /* Keep name font maybe? */}
        .doctor-name-spec h2::after { display: none; }
        .doctor-name-spec p.specialization { color: var(--accent-primary); font-weight: 600; font-size: 1.1rem; margin-bottom: 0.5rem; }

         /* Doctor Details & Rating Summary */
         .doctor-details { margin-top: 0.5rem; }
         .doctor-details p, .doctor-details ul li { color: var(--text-medium); font-size: 0.98rem; margin-bottom: 0.8rem; display: flex; align-items: center; }
         .doctor-details ul { list-style: none; padding-left: 0; } /* padding-right for RTL maybe? No, padding-left: 0 is ok */
         .doctor-details ul li i, .doctor-details p i { margin-right: 0.8rem; color: var(--accent-primary-light); width: 1.4em; text-align: center; flex-shrink: 0; font-size: 1.1em; }

         /* Rating Summary Styles */
         .rating-summary { display: flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem; margin-bottom: 1rem; }
         .rating-summary .stars { display: flex; gap: 2px; font-size: 1.1em; }
         .rating-summary .rating-text { font-size: 0.95rem; color: var(--text-medium); }

        /* --- STAR COLOR RULES --- */
        .rating-summary .stars, .review-rating .stars {} /* No color */
        .rating-summary .stars i.fas.fa-star, .rating-summary .stars i.fas.fa-star-half-alt,
        section.reviews-section div.review-rating.stars i.fas.fa-star,
        section.reviews-section div.review-rating.stars i.fas.fa-star-half-alt {
            color: var(--accent-warm) !important;
        }
        .rating-summary .stars i.far.fa-star,
        section.reviews-section div.review-rating.stars i.far.fa-star {
            color: var(--border-color-strong) !important;
        }
        .rating-input input[type="radio"]:checked ~ label,
        .rating-input label:hover, .rating-input label:hover ~ label {
            color: var(--accent-warm);
         }
         /* Other doctor detail icons */
         .doctor-details i.fa-map-marker-alt, .doctor-details i.fa-clinic-medical { color: var(--accent-primary); }

        /* --- Booking Form Styles --- */
        .form-section-wrapper h3 { display: flex; align-items: center; gap: 0.8rem; }
        .form-section-wrapper h3 i { color: var(--accent-primary); font-size: 1.1em; margin-top: -2px; margin-right: 0.8rem; } /* Added margin-right for icon before text */
        .form-group { display: flex; flex-direction: column; gap: 0.4rem; margin-bottom: 1.3rem; }
        label { font-weight: 600; color: var(--text-dark); font-size: 1rem; margin-bottom: 0.4rem; display: block; /* Ensure label takes width for alignment */}
        input[type="text"], input[type="tel"], textarea, select { width: 100%; padding: 0.9rem 1rem; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); color: var(--text-dark); font-size: 1rem; transition: border-color var(--transition-speed) var(--transition-ease), box-shadow var(--transition-speed) var(--transition-ease); font-family: var(--font-primary); /* Apply font */}
        input[type="text"]:focus, input[type="tel"]:focus, textarea:focus, select:focus { outline: none; border-color: var(--border-color-focus); box-shadow: 0 0 0 3px rgba(0, 122, 122, 0.15); }
        textarea { min-height: 100px; resize: vertical; }

        /* --- Date/Time Selection --- */
        .selection-container { background-color: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; padding: 1.2rem; min-height: 80px; margin-top: 0.5rem; }
        .date-selection-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 0.8rem; }
        .time-slots-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(95px, 1fr)); gap: 0.7rem; }
        .slot-card { padding: 0.8rem 0.6rem; border: 1px solid var(--border-color); border-radius: 6px; background-color: var(--bg-primary); color: var(--text-dark); font-weight: 600; text-align: center; cursor: pointer; transition: all var(--transition-speed) var(--transition-ease); font-size: 0.95rem; display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 55px; line-height: 1.4; box-shadow: 0 2px 4px var(--shadow-color); }
        .slot-card:hover { border-color: var(--accent-primary-light); background-color: var(--bg-primary); transform: translateY(-3px); box-shadow: 0 5px 12px var(--shadow-color-medium); color: var(--accent-primary-dark); }
        .slot-card.selected { background-color: var(--accent-selected); color: var(--accent-selected-text); border-color: var(--accent-selected); font-weight: 700; box-shadow: 0 3px 8px rgba(0, 76, 76, 0.2); transform: translateY(-1px); }
        .slot-card.selected .day-name { color: rgba(255, 255, 255, 0.85); }
        .slot-card.disabled { background-color: var(--accent-disabled-bg); color: var(--accent-disabled-text); cursor: not-allowed; border-color: var(--accent-disabled-border); opacity: 0.7; box-shadow: none; transform: none; pointer-events: none; }
        .slot-card .day-number { font-size: 1.3rem; font-weight: 700; display: block; line-height: 1.1; }
        .slot-card .day-name { font-size: 0.75rem; text-transform: uppercase; color: var(--text-medium); display: block; margin-top: 3px; font-weight: 400; }
        .slots-message { grid-column: 1 / -1; text-align: center; padding: 1.5rem 1rem; color: var(--text-medium); font-style: italic; font-size: 0.95rem; }
        .slots-message i { margin-right: 10px; color: var(--accent-primary); } /* Icon before text */
        .slots-message.error { color: var(--error); font-style: normal; font-weight: 600;}
        .slots-message.error i { color: var(--error); }

        /* --- Buttons --- */
        .btn { padding: 0.7rem 1.5rem; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.95rem; text-align: center; transition: all var(--transition-speed) var(--transition-ease); border: 1px solid transparent; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; gap: 0.6rem; line-height: 1.2; box-shadow: 0 2px 4px var(--shadow-color); font-family: var(--font-primary); } /* Apply font */
        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 5px 12px var(--shadow-color-medium); }
        .btn:active:not(:disabled) { transform: translateY(0px); box-shadow: 0 2px 4px var(--shadow-color); }
        .btn:disabled { background-color: var(--accent-disabled-bg); border-color: var(--accent-disabled-border); color: var(--accent-disabled-text); cursor: not-allowed; opacity: 0.7; box-shadow: none; transform: none; }
        .btn-primary { background-color: var(--accent-primary); color: var(--text-light); border-color: var(--accent-primary); font-size: 1rem; padding: 0.8rem 1.8rem; }
        .btn-primary:hover:not(:disabled) { background-color: var(--accent-primary-dark); border-color: var(--accent-primary-dark); }
        .btn-secondary { background-color: transparent; color: var(--accent-primary); border-color: var(--accent-primary); box-shadow: none; }
        .btn-secondary:hover:not(:disabled) { background-color: var(--bg-accent-very-light); border-color: var(--accent-primary); color: var(--accent-primary-dark); }
        .btn i { margin-right: 6px; } /* Default icon margin */
        .btn-block { width: 100%; margin-top: 1.5rem; }

        /* Separator */
        hr { border: none; border-top: 1px solid var(--border-color); margin: 2rem 0; }

        /* --- Reviews Display & Form --- */
        .reviews-section { margin-top: 0; } /* Remove potential double margin */
        .reviews-section h3 i { margin-right: 8px; color: var(--accent-primary);} /* Icon before text */
        .review-list { list-style: none; padding: 0; margin: 0; max-height: 450px; /* Adjust max height */ overflow-y: auto; /* Enable scroll */ border-top: 1px solid var(--border-color); margin-top: 1.5rem; padding-top: 1.5rem; }
        .review-item { border-bottom: 1px dashed var(--border-color); padding-bottom: 1.5rem; margin-bottom: 1.5rem; }
        .review-item:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .review-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.8rem; flex-wrap: wrap; gap: 0.5rem; }
        .reviewer-info strong { font-weight: 600; color: var(--text-dark); }
        .reviewer-info span { font-size: 0.85rem; color: var(--text-medium); margin-left: 0.5rem; white-space: nowrap;} /* Span AFTER name */
         .review-rating .stars { font-size: 1em; display: flex; gap: 2px; } /* Star colors handled globally */
         .review-comment { color: var(--text-medium); line-height: 1.6; margin-top: 0.5rem; word-wrap: break-word; text-align: right; } /* Ensure comment text is right aligned */
         .no-reviews { text-align: center; color: var(--text-medium); padding: 1.5rem 1rem; font-style: italic; background-color: var(--bg-secondary); border-radius: 6px; margin-top: 1rem; }
         .no-reviews i { margin-right: 8px; } /* Icon before text */
         /* Review Submission Form Specifics */
         #review-form { margin-top: 2rem; border-top: 1px solid var(--border-color); padding-top: 2rem;}
         .review-form-note { background-color: var(--bg-accent-very-light); border-left: 4px solid var(--info); padding: 1rem; margin: 1rem 0 1.5rem 0; border-radius: 4px; font-size: 0.95rem; color: var(--text-medium); }
         .review-form-note strong { color: var(--text-dark); }
         .rating-input { display: flex; justify-content: center; align-items: center; gap: 5px; margin-bottom: 1rem; flex-direction: row-reverse; /* Keeps visual order 5->1 LTR, but default fills left-to-right */}
         .rating-input input[type="radio"] { display: none; /* Hide actual radio */ }
         .rating-input label { font-size: 1.8rem; color: var(--border-color-strong); cursor: pointer; transition: color 0.2s ease; }
         /* Star input colors handled above */


        /* --- Flash Messages --- */
        .flash-messages { position: fixed; top: 90px; right: 20px; left: auto; /* Explicitly set left to auto */ z-index: 1050; width: clamp(300px, 90%, 420px); }
        .flash-message { padding: 1rem 1.5rem; margin-bottom: 1rem; border-radius: 6px; font-weight: 500; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15); opacity: 0; transform: translateX(100%); animation: slideInFadeOut 5s ease-in-out forwards; border: 1px solid transparent; display: flex; align-items: center; gap: 1rem; background-color: var(--bg-primary); border-left: 5px solid transparent; /* Default side border LTR */}
        .flash-message::before { font-family: "Font Awesome 6 Free"; font-weight: 900; font-size: 1.2em; /* Icon is usually first */ }
        .flash-message.success { border-left-color: var(--success); color: #057a55; } .flash-message.success::before { content: '\f058'; color: var(--success); }
        .flash-message.error { border-left-color: var(--error); color: #b91c1c; } .flash-message.error::before { content: '\f071'; color: var(--error); }
        .flash-message.info { border-left-color: var(--info); color: #1d4ed8; } .flash-message.info::before { content: '\f05a'; color: var(--info); }

        /* --- Keyframes for Flash Message (Adjust transform for RTL start/end if needed - translateX(100%) is correct for right side) --- */
        @keyframes slideInFadeOut {
             0% { opacity: 0; transform: translateX(100%); } /* Start off-screen right */
             10% { opacity: 1; transform: translateX(0); }   /* Slide in to final position */
             90% { opacity: 1; transform: translateX(0); }   /* Stay visible */
             100% { opacity: 0; transform: translateX(100%); } /* Slide out to the right */
        }


        /* ======================================= */
        /* ========== RTL OVERRIDES ============ */
        /* ======================================= */
        [dir="rtl"] {
            /* --- General Text Alignment --- */
             body { text-align: right; }
             label { text-align: right; }
            input, textarea, select { text-align: right; } /* Align input text right */
            textarea::placeholder { text-align: right; } /* Align placeholder too */
            input::placeholder { text-align: right; } /* Align placeholder too */


            /* --- Header --- */
            .page-top-bar h1 { text-align: right; }
            .back-button i { margin-right: 0; margin-left: 0.6rem; /* Swap margin for icon */}
            /* Use fa-arrow-right for RTL 'back'? Keep semantic fa-arrow-left is fine often. */
            .back-button i.fa-arrow-left::before { content: "\f061"; } /* VISUALLY flip arrow */


             /* --- Headings --- */
            h2::after, h3::after { left: auto; right: 0; /* Position underline on the right */}


            /* --- Doctor Details --- */
            .doctor-details ul { padding-left: 0; padding-right: 0; /* Reset padding */ }
            .doctor-details ul li i, .doctor-details p i { margin-right: 0; margin-left: 0.8rem; /* Swap margin */}


            /* --- Form --- */
            .form-section-wrapper h3 i { margin-right: 0; margin-left: 0.8rem; /* Swap icon margin */ }
             .slots-message i { margin-right: 0; margin-left: 10px; /* Swap icon margin */}
             .btn i { margin-right: 0; margin-left: 0.6rem; /* Swap button icon margin */}


             /* --- Reviews --- */
             .reviews-section h3 i { margin-right: 0; margin-left: 8px; /* Swap icon margin */ }
             .reviewer-info span { margin-left: 0; margin-right: 0.5rem; /* Swap margin for date */}
            .review-comment { text-align: right; }
             .no-reviews i { margin-right: 0; margin-left: 8px; /* Swap icon margin */ }
             .review-form-note {
                 border-left: none; /* Remove left border */
                 border-right: 4px solid var(--info); /* Add right border */
             }
             .rating-input {
                 flex-direction: row; /* Default row direction makes stars fill R-to-L visually when HTML is 5->1 */
             }

             /* --- Flash Messages --- */
             .flash-messages { right: auto; left: 20px; /* Position on the Left for RTL */ }
             .flash-message {
                 /* Swap the border side */
                 border-left: none !important; /* Override base style */
                 border-right: 5px solid transparent; /* Add border to the right */
                  /* Adjust gap if icon should be on the other side of text? Usually icon first is fine */
             }
            .flash-message.success { border-right-color: var(--success); }
            .flash-message.error { border-right-color: var(--error); }
            .flash-message.info { border-right-color: var(--info); }

            /* Animation Start/End needs flipping for Left position */
             @keyframes slideInFadeOut { /* Re-declare animation fully within [dir=rtl] scope? Simpler to adjust transform */
                0% { opacity: 0; transform: translateX(-100%); } /* Start off-screen LEFT */
                10% { opacity: 1; transform: translateX(0); }
                90% { opacity: 1; transform: translateX(0); }
                100% { opacity: 0; transform: translateX(-100%); } /* Fade out to LEFT */
             }
             .flash-message {
                animation: slideInFadeOut 5s ease-in-out forwards; /* Re-apply corrected animation */
                transform: translateX(-100%); /* Set initial state for animation */
             }


            /* --- Responsive - check overrides if needed */
             @media (max-width: 480px) {
                 /* Align form content right on small screens if needed */
                 .form-section-wrapper, .info-section, .reviews-section { text-align: right; }
                .doctor-profile-header { text-align: right; } /* Align center text if previously centered */
                .review-header { align-items: flex-end; } /* Adjust review header stacking */
                 .flash-messages { width: clamp(280px, 95%, 95%); left: 2.5%; right: auto; /* Adjust flash message pos for RTL mobile */ }
             }
        }

        /* --- Responsive Adjustments (Keep Original - RTL rules will override where needed) --- */
         @media (max-width: 992px) {
             main { gap: 1.8rem; }
             .info-section, .form-section-wrapper, .reviews-section { padding: 1.5rem; }
             .doctor-photo-large-container { width: 120px; height: 120px;}
             h2 {font-size: 1.5rem;} h3 {font-size: 1.3rem;}
         }
        @media (max-width: 768px) {
             main { grid-template-columns: 1fr; margin-top: 1.5rem; gap: 1.8rem; }
            .page-top-bar { padding: 0.8rem 5%; }
            .page-top-bar h1 { font-size: 1.3rem;}
            .back-button { padding: 0.6rem 1rem; font-size: 0.85rem;}
            h2 {font-size: 1.4rem;} h3 {font-size: 1.25rem;}
            .doctor-profile-header { flex-direction: column; text-align: center; } /* Center alignment override */
            .doctor-photo-large-container { width: 130px; height: 130px;}
            .form-group { margin-bottom: 1rem;}
            .selection-container { padding: 1rem;}
            .date-selection-grid { grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 0.7rem; }
            .time-slots-grid { grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 0.6rem; }
            .slot-card { font-size: 0.9rem; min-height: 50px;}
            .btn {padding: 0.65rem 1.3rem; font-size: 0.9rem;}
            .btn-primary {padding: 0.75rem 1.5rem;}
            .info-column, .form-column { grid-column: 1 / -1; }
         }
        @media (max-width: 480px) {
            body { font-size: 15px; }
            .page-top-bar { padding: 0.7rem 4%;}
            .page-top-bar h1 { font-size: 1.15rem;}
            main { padding: 0 0.5rem;}
            .info-section, .form-section-wrapper, .reviews-section { padding: 1.2rem; }
            .doctor-photo-large-container { width: 110px; height: 110px;}
            .doctor-name-spec h2 { font-size: 1.5rem; }
            .doctor-name-spec p.specialization { font-size: 1rem; }
            .date-selection-grid, .time-slots-grid { grid-template-columns: repeat(3, 1fr); gap: 0.5rem; }
            input[type="text"], input[type="tel"], textarea, select { padding: 0.8rem; font-size: 0.95rem; }
             .slot-card { font-size: 0.85rem; min-height: 50px; padding: 0.6rem 0.4rem;}
             .slot-card .day-number { font-size: 1.1rem;}
             .slot-card .day-name { font-size: 0.7rem;}
            /* Original Flash Message mobile pos commented out - RTL rule handles it now
            .flash-messages { width: clamp(280px, 95%, 95%); right: 2.5%; top: 75px;}
            */
            .rating-input label { font-size: 1.6rem; } /* Slightly smaller stars on mobile */
            .review-header { flex-direction: column; align-items: flex-start; gap: 0.2rem;} /* Stack review header on mobile */
        }


    </style>
</head>
<body>
    <!-- Flash Messages Div -->
    <div class="flash-messages">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    {% set category_class = category if category in ['success', 'error', 'info'] else 'info' %}
                    <div class="flash-message {{ category_class }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>

    <!-- Header -->
    <header class="page-top-bar">
        <h1>احجز عند الدكتور <span>{{ doctor.name | default('N/A') }}</span></h1> {# Corrected Title Structure #}
        <a href="{{ url_for('home') }}" class="back-button">
             الصفحة الرئيسية <i class="fas fa-arrow-left"></i> {# Icon visually flipped by CSS #}
        </a>
    </header>

    <!-- Main Content -->
    <main>
        {# --- Right Column (Doctor Info + Reviews Display - visual order in RTL) --- #}
        <div class="info-column">
            {# --- Doctor Profile Section --- #}
            <section class="info-section doctor-profile-section">
                 <div class="doctor-profile-header">
                     <div class="doctor-photo-large-container">
                        <img src="{{ doctor.photo or 'https://via.placeholder.com/150/E0F2F2/007A7A?text=Photo' }}" class="doctor-photo-large" alt="صورة {{ doctor.name }}"> {# Alt text translation #}
                     </div>
                     <div class="doctor-name-spec">
                        <h2>{{ doctor.name | default('N/A') }}</h2>
                         <p class="specialization">{{ doctor.specialization | default('ممارسة عامة') }}</p> {# Specialization translation #}
                        <!-- Rating Summary -->
                         <div class="rating-summary">
                            {% if doctor.review_count > 0 %}
                                <span class="rating-text">{{ doctor.average_rating | round(1) }}/5 ({{ doctor.review_count }} تقييم{% if doctor.review_count != 1 %}ات{% endif %})</span> {# Review text translation #}
                                <div class="stars" title="{{ doctor.average_rating }}/5 نجوم"> {# Stars text translation #}
                                     {% for star_class in get_stars(doctor.average_rating) %}
                                         <i class="{{ star_class }}"></i>
                                     {% endfor %}
                                </div>
                             {% else %}
                                <span class="rating-text">لا يوجد تقييمات بعد <i class="far fa-star" style="margin-left: 4px; margin-right:0;"></i></span> {# Adjusted Text + icon pos #}
                            {% endif %}
                        </div>
                    </div> {# End doctor-name-spec #}
                </div> {# End doctor-profile-header #}

                 <div class="doctor-details">
                    {% if doctor.description %}<p>{{ doctor.description }}</p>{% endif %}
                    <ul>
                        {% if doctor.province or doctor.governorate %}
                              <li> <i class="fas fa-map-marker-alt"></i>الموقع: {{ doctor.governorate | default('N/A') }}{{ ', ' if doctor.governorate and doctor.province else '' }}{{ doctor.province | default('') }}</li> {# Text translation #}
                        {% endif %}
                        {% if doctor.plc %}
                             <li><i class="fas fa-clinic-medical"></i> يعمل في {{ doctor.plc }} ({{ doctor.facility_type | default('عيادة/مركز') }})</li> {# Text translation #}
                         {% elif doctor.facility_type %}
                             <li> <i class="fas fa-hospital"></i>نوع المنشأة: {{ doctor.facility_type }}</li> {# Text translation #}
                         {% endif %}
                     </ul>
                 </div>
             </section> {# End doctor-profile-section #}

            <!-- Reviews Section (Display + Form) -->
            <section class="reviews-section">
                <h3><i class="fas fa-comments"></i> تعليقات و تقييمات المرضى للطبيب</h3>

                <!-- Display Recent Reviews -->
                {% if reviews %}
                     <ul class="review-list">
                         {% for review in reviews %}
                         <li class="review-item">
                             <div class="review-header">
                                <div class="reviewer-info">
                                    <strong>{{ review.reviewer_name | default('مجهول') | title }}</strong> {# Anonymous translation #}
                                     {% set review_date = review.created_at | string | truncate(10, True, '') if review.created_at else 'بتاريخ غير معروف' %} {# Date translation #}
                                     <span> - تمت المراجعة بتاريخ {{ review_date }}</span> {# Reviewed on translation #}
                                 </div>
                                 <div class="review-rating stars" title="{{ review.rating }}/5 نجوم"> {# Stars translation #}
                                     {% for star_class in get_stars(review.rating) %}
                                         <i class="{{ star_class }}"></i>
                                     {% endfor %}
                                 </div>
                             </div> {# End review-header #}
                             {% if review.comment %}
                                <p class="review-comment">{{ review.comment | safe }}</p>
                             {% else %}
                                 <p class="review-comment" style="font-style: italic; color: var(--text-medium);">(لا يوجد تعليق)</p> {# No comment translation #}
                             {% endif %}
                         </li> {# End review-item #}
                         {% endfor %}
                    </ul>
                {% else %}
                    <div class="no-reviews">
                        <i class="fas fa-comment-slash"></i> لا يوجد تعليقات سابقة للدكتور {{ doctor.name }}.
                    </div>
                {% endif %}

                <hr style="margin: 2rem 0 1.5rem 0;">

                 <!-- Review Submission Form -->
                 <h3><i class="fas fa-pencil-alt"></i>اترك تعليقك ليستفيد غيرك</h3>
                <div class="review-form-note">
                     <strong>ملاحظة:</strong> يمكن فقط للمرضى الذين قاموا بالحجز مع هذا الطبيب (باستخدام نفس الاسم أو رقم الهاتف المدخل أدناه) إضافة تقييم. {# Adjusted Note Translation #}
                </div>

                <form id="review-form" method="POST" action="{{ url_for('submit_review') }}">
                    <input type="hidden" name="doctor_id" value="{{ doctor.id }}">

                    <div class="form-group">
                        <label for="reviewerName">اسمك المستخدم في الحجز:</label> {# Label translation #}
                        <input type="text" id="reviewerName" name="reviewer_name" required autocomplete="name" placeholder="مثال: أحمد محمد"> {# Placeholder translation #}
                    </div>

                     <div class="form-group">
                        <label for="reviewerPhone">رقم هاتفك المستخدم في الحجز:</label> {# Label translation #}
                         <input type="tel" id="reviewerPhone" name="reviewer_phone" required pattern="[0-9]{7,15}" title="رقم الهاتف المستخدم للحجز (7-15 رقم)" autocomplete="tel" placeholder="مثال: 77xxxxxxx"> {# Pattern/Title/Placeholder updated for typical Yemen mobile #}
                     </div>

                    <div class="form-group">
                         <label>تقييمك للطبيب:</label> {# Label translation #}
                        <div class="rating-input">
                            <input type="radio" id="star5" name="rating" value="5" required><label for="star5" title="5 نجوم">★</label>
                            <input type="radio" id="star4" name="rating" value="4"><label for="star4" title="4 نجوم">★</label>
                            <input type="radio" id="star3" name="rating" value="3"><label for="star3" title="3 نجوم">★</label>
                            <input type="radio" id="star2" name="rating" value="2"><label for="star2" title="2 نجوم">★</label>
                            <input type="radio" id="star1" name="rating" value="1"><label for="star1" title="نجمة واحدة">★</label> {# Title translations #}
                         </div>
                     </div>

                    <div class="form-group">
                         <label for="comment">تعليقك (اختياري):</label> {# Label translation #}
                         <textarea id="comment" name="comment" rows="4" placeholder="شارك تفاصيل تجربتك (وقت الانتظار ، الموظفين ، الرعاية التي تلقيتها ...)" maxlength="1000"></textarea> {# Placeholder translation #}
                    </div>

                    <button type="submit" class="btn btn-primary btn-block" style="background-color: var(--accent-primary-dark);">
                         إرسال التعليق <i class="fas fa-paper-plane"></i> {# Text & icon order #}
                    </button>
                </form>
            </section> {# End reviews-section #}
        </div> {# End Info Column #}


        {# --- Left Column (Booking Form - visual order in RTL) --- #}
        <div class="form-column">
             <section class="form-section-wrapper booking-form-wrapper">
                 <form id="booking-form" method="POST" action="{{ url_for('confirm_booking') }}">
                     {# Hidden fields remain unchanged #}
                    <input type="hidden" name="doctor_id" value="{{ doctor.id }}">
                    <input type="hidden" name="doctor_name" value="{{ doctor.name }}">
                     <input type="hidden" name="fingerprint" id="fingerprint-input">
                    <input type="hidden" name="booking_date" id="selectedDateInput" required>
                    <input type="hidden" name="booking_time" id="selectedTimeInput" required>

                    <h3><i class="fas fa-calendar-check"></i>اختر تاريخ ووقت الحجز</h3> {# Translation + icon LTR/RTL fixed #}

                    {# Find Nearest Button #}
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <button type="button" id="findNearestBtn" class="btn btn-secondary" style="width: 100%;">
                             اختر لي أقرب حجز متاح <i class="fas fa-forward"></i> {# Translation + Icon Order Fixed #}
                         </button>
                         <div id="findNearestStatus" style="font-size: 0.85rem; text-align: center; margin-top: 5px; color: var(--text-medium); min-height: 1.2em;"></div>
                    </div>

                     {# Month Selection #}
                     <div class="form-group">
                        <label for="monthSlotsContainer">1. اختر الشهر:</label> {# Translation #}
                        <div id="monthSlotsContainer" class="selection-container date-selection-grid">
                             <div class="slots-message"><i class="fas fa-spinner fa-spin"></i> جاري التحميل...</div> {# Translation #}
                        </div>
                     </div>

                     {# Day Selection #}
                    <div class="form-group" id="daySelectionGroup" style="display: none;">
                        <label for="daySlotsContainer">2. اختر اليوم:</label> {# Translation #}
                         <div id="daySlotsContainer" class="selection-container date-selection-grid">
                              <div class="slots-message"><i class="fas fa-mouse-pointer"></i> يرجى اختيار الشهر أولاً.</div> {# Translation + icon #}
                         </div>
                     </div>

                     {# Time Selection #}
                    <div class="form-group" id="timeSelectionGroup" style="display: none;">
                         <label for="timeSlotsContainer">3. اختر الوقت:</label> {# Translation #}
                         <div id="timeSlotsContainer" class="selection-container time-slots-grid">
                             <div class="slots-message"><i class="fas fa-mouse-pointer"></i> يرجى اختيار اليوم أولاً.</div> {# Translation + icon #}
                        </div>
                    </div>

                    <hr>

                    <h3><i class="fas fa-user-edit"></i>تفاصيل المريض</h3> {# Translation + Icon fixed #}

                    <div class="form-group">
                         <label for="patientName">اسم المريض الكامل:</label> {# Translation #}
                         <input type="text" id="patientName" name="patient_name" required autocomplete="name" placeholder="الاسم الكامل" pattern="^[\u0600-\u06FF\s]{2,}|[A-Za-z\s]{2,}$" title="أدخل حرفين على الأقل (حروف عربية أو إنجليزية ومسافات فقط)" maxlength="100"> {# Adjusted pattern and title for Arabic/English Names #}
                     </div>

                    <div class="form-group">
                         <label for="patientPhone">رقم هاتف المريض:</label> {# Translation #}
                         <input type="tel" id="patientPhone" name="patient_phone" required pattern="[0-9]{7,15}" title="أدخل 7-15 رقمًا" autocomplete="tel" placeholder="رقم الهاتف (مثال: 77xxxxxxx)" maxlength="15"> {# Adjusted placeholder/pattern/title for Yemen Mobile #}
                    </div>

                     <div class="form-group">
                         <label for="notes">ملاحظات للطبيب (اختياري):</label> {# Translation #}
                         <textarea id="notes" name="notes" placeholder="مثال: سبب الزيارة، الحالات السابقة..." maxlength="500"></textarea> {# Translation #}
                     </div>

                    <button type="submit" id="confirmButton" class="btn btn-primary btn-block" disabled>
                        حدد التاريخ والوقت للتأكيد <i class="fas fa-lock"></i> {# Translation + icon order #}
                    </button>
                </form>
            </section>
         </div>
    </main>

     <script>
        // --- JAVASCRIPT UNCHANGED as requested ---
        // --- GLOBAL VARS ---
        const doctorId = "{{ doctor.id | safe }}"; // Ensure ID is safe if passed directly
        const doctorAvailabilitySchedule = {{ doctor.availability | tojson | safe }}; // Get schedule from backend variable
         const today = new Date(); // Today's date object
        today.setHours(0, 0, 0, 0); // Normalize to midnight
        const todayString = today.toISOString().split('T')[0]; // YYYY-MM-DD format

         // --- DOM Elements ---
        const monthSlotsContainer = document.getElementById('monthSlotsContainer');
        const daySelectionGroup = document.getElementById('daySelectionGroup');
        const daySlotsContainer = document.getElementById('daySlotsContainer');
        const timeSelectionGroup = document.getElementById('timeSelectionGroup');
        const timeSlotsContainer = document.getElementById('timeSlotsContainer');
        const selectedDateInput = document.getElementById('selectedDateInput');
        const selectedTimeInput = document.getElementById('selectedTimeInput');
        const confirmButton = document.getElementById('confirmButton');
        const findNearestBtn = document.getElementById('findNearestBtn');
        const findNearestStatus = document.getElementById('findNearestStatus');

        // --- State Variables ---
        let selectedMonthYear = null; // e.g., '2024-01'
        let selectedDate = null;      // e.g., '2024-01-15'
        let selectedTime = null;      // e.g., '10:00-10:20'
        // Correct Arabic Weekdays if needed for getDayName logic (though only used internally for schedule matching here)
        // const weekdays = ["الأحد", "الاثنين", "الثلاثاء", "الأربعاء", "الخميس", "الجمعة", "السبت"];
        const weekdays = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"]; // KEEPING ENGLISH for backend schedule keys
        let isFindingNearest = false; // Prevent multiple simultaneous "find nearest" clicks

        // Define button texts in one place for easier potential translation if needed later
        const buttonTexts = {
             confirmDefault: '<i class="fas fa-lock"></i> حدد التاريخ والوقت للتأكيد',
             confirmReady: '<i class="fas fa-check-circle"></i> تأكيد الحجز', // Translate this
             confirmSelectDayTime: '<i class="fas fa-lock"></i> حدد اليوم والوقت للحجز',
             confirmSelectTime: '<i class="fas fa-lock"></i> حدد الوقت للحجز',
             findNearestDefault: 'اختر لي أقرب حجز متاح <i class="fas fa-forward"></i>',
             findNearestSearching: '<i class="fas fa-spinner fa-spin"></i> جاري البحث...', // Translate this
         };

        // --- Helper Functions ---
        function clearSelectionUI(container) { container.innerHTML = ''; }
        function displayMessage(container, message, type = 'info') {
            const iconClass = type === 'loading' ? 'fas fa-spinner fa-spin' :
                              type === 'error' ? 'fas fa-exclamation-triangle' :
                              'fas fa-info-circle';
            // Adjust icon placement visually for RTL text message if needed
            container.innerHTML = `<div class="slots-message ${type === 'error' ? 'error' : ''}">${message} <i class="${iconClass}"></i></div>`;
        }

        // *** UPDATED updateButtonState function ***
        function updateButtonState() {
             if (selectedMonthYear && selectedDate && selectedTime) {
                confirmButton.disabled = false;
                 confirmButton.innerHTML = buttonTexts.confirmReady;
            } else {
                confirmButton.disabled = true;
                let buttonText = buttonTexts.confirmDefault; // Default
                if (!selectedMonthYear) buttonText = buttonTexts.confirmDefault; // Keep default if nothing selected
                 else if (!selectedDate) buttonText = buttonTexts.confirmSelectDayTime; // Need Day & Time
                 else if (!selectedTime) buttonText = buttonTexts.confirmSelectTime; // Need Time
                confirmButton.innerHTML = buttonText;
             }
         }
         function getDayName(date) { return weekdays[date.getDay()]; }
         function isDoctorGenerallyAvailable(dayName) {
            const scheduleForDay = doctorAvailabilitySchedule[dayName];
            return Array.isArray(scheduleForDay) && scheduleForDay.length > 0 && scheduleForDay[0].toLowerCase() !== 'unavailable';
         }
         function parseTime(timeString) {
             if (!timeString || typeof timeString !== 'string') return null;
             try {
                 const timePart = timeString.split('-')[0].trim();
                 const match = timePart.match(/^(\d{1,2}):(\d{2})$/);
                 if (match) {
                    const hours = parseInt(match[1], 10); const minutes = parseInt(match[2], 10);
                     if (hours >= 0 && hours < 24 && minutes >= 0 && minutes < 60) { return { hours, minutes }; }
                 }
             } catch (e) { console.error(`Error parsing time: ${timeString}`, e); } return null;
         }

        // --- Core Logic Functions ---
        function generateMonthCards() {
            clearSelectionUI(monthSlotsContainer);
            const monthsToShow = 6;
            let monthsGenerated = 0;
            const displayedMonths = new Set();
             const currentLocale = document.documentElement.lang || 'ar'; // Get page lang for formatting

            for (let i = 0; i < monthsToShow * 31; i++) {
                const checkDate = new Date(today);
                checkDate.setDate(today.getDate() + i);
                const dayName = getDayName(checkDate); // Uses English day name for backend schedule check

                if (isDoctorGenerallyAvailable(dayName)) {
                     const monthYear = `${checkDate.getFullYear()}-${String(checkDate.getMonth() + 1).padStart(2, '0')}`;
                     if (!displayedMonths.has(monthYear) && displayedMonths.size < monthsToShow) {
                        displayedMonths.add(monthYear);
                         const dateForMonth = new Date(checkDate.getFullYear(), checkDate.getMonth(), 1);
                         // Use Arabic locale for month display
                         const monthName = dateForMonth.toLocaleDateString(currentLocale, { month: 'long' });
                        const year = dateForMonth.getFullYear();

                        const card = document.createElement('button');
                         card.type = 'button'; card.classList.add('slot-card');
                        card.dataset.monthYear = monthYear;
                        card.innerHTML = `${monthName}<span class="day-name" style="font-size:0.75rem;">${year}</span>`;
                        card.addEventListener('click', () => handleMonthClick(monthYear));
                        monthSlotsContainer.appendChild(card);
                        monthsGenerated++;
                     }
                 }
                 if (displayedMonths.size >= monthsToShow) break;
             }

             if (monthsGenerated === 0) {
                 // Translate message
                 displayMessage(monthSlotsContainer, 'لم يتم العثور على أشهر متاحة في المستقبل القريب لهذا الطبيب.');
             } else {
                 // Clear potential initial loading message if months were generated
                const loadingMsg = monthSlotsContainer.querySelector('.slots-message');
                 if (loadingMsg && loadingMsg.textContent.includes("جاري التحميل")) { // Check specific text maybe?
                    loadingMsg.remove();
                }
             }
         }

        function handleMonthClick(monthYear) {
            selectedMonthYear = monthYear;
            selectedDate = null; selectedTime = null;
            selectedDateInput.value = ''; selectedTimeInput.value = '';
             document.querySelectorAll('#monthSlotsContainer .slot-card').forEach(card => { card.classList.toggle('selected', card.dataset.monthYear === monthYear); });
            daySelectionGroup.style.display = 'block'; timeSelectionGroup.style.display = 'none';
            clearSelectionUI(timeSlotsContainer);
            displayMessage(daySlotsContainer, 'جاري تحميل الأيام المتاحة...', 'loading'); // Translate message
            updateButtonState();
            generateDayCards(monthYear);
         }

        function generateDayCards(monthYear) {
             clearSelectionUI(daySlotsContainer);
             const [year, month] = monthYear.split('-').map(Number);
             const daysInMonth = new Date(year, month, 0).getDate();
             let daysGenerated = 0;
             const currentLocale = document.documentElement.lang || 'ar'; // For day name display

             // Define Arabic short weekdays map if needed for display
             const arabicShortWeekdays = ["أحد", "اثنين", "ثلاثاء", "أربعاء", "خميس", "جمعة", "سبت"];

             for (let day = 1; day <= daysInMonth; day++) {
                 const currentDate = new Date(year, month - 1, day);
                 if (currentDate < today) continue;

                 const currentDateString = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                 const dayIndex = currentDate.getDay();
                 const englishDayName = weekdays[dayIndex]; // Get English name for schedule check
                 const displayDayName = arabicShortWeekdays[dayIndex]; // Get Arabic name for display

                 if (isDoctorGenerallyAvailable(englishDayName)) { // Check using English name
                     daysGenerated++;
                     const card = document.createElement('button');
                     card.type = 'button'; card.classList.add('slot-card');
                     card.dataset.date = currentDateString;
                     card.innerHTML = `<span class="day-number">${day}</span><span class="day-name">${displayDayName}</span>`; // Display Arabic short day name
                     card.addEventListener('click', () => handleDayClick(currentDateString));
                     daySlotsContainer.appendChild(card);
                 }
             }
            if (daysGenerated === 0) {
                 displayMessage(daySlotsContainer, 'لم يتم العثور على أيام متاحة لهذا الشهر بناءً على الجدول الزمني.'); // Translate message
             }
         }

        function handleDayClick(dateString) {
            selectedDate = dateString; selectedTime = null;
            selectedDateInput.value = dateString; selectedTimeInput.value = '';
            document.querySelectorAll('#daySlotsContainer .slot-card').forEach(card => { card.classList.toggle('selected', card.dataset.date === dateString); });
            timeSelectionGroup.style.display = 'block';
            displayMessage(timeSlotsContainer, 'جاري تحميل الأوقات المتاحة...', 'loading'); // Translate message
            updateButtonState();
            fetchAndDisplayTimeSlots(dateString);
         }

         async function fetchAndDisplayTimeSlots(dateString, timeToSelect = null) {
             clearSelectionUI(timeSlotsContainer);
             if (!selectedDate) {
                 displayMessage(timeSlotsContainer, 'الرجاء تحديد يوم أولاً.', 'error'); // Translate message
                 return false;
             }
             displayMessage(timeSlotsContainer, '<i class="fas fa-spinner fa-spin"></i> جاري تحميل الأوقات المتاحة...', 'loading'); // Translate message

             try {
                const response = await fetch(`/get-available-slots/${doctorId}/${dateString}`);
                if (!response.ok) {
                     // Translate potential default error
                     let errorMsg = 'فشل في جلب فترات الوقت المتاحة.';
                    try {
                         // Assume backend error might also be translated or use as is
                        const errorData = await response.json(); errorMsg = errorData.error || errorMsg;
                    } catch (_) {}
                    throw new Error(`${errorMsg} (${response.status})`);
                }
                 const availableSlots = await response.json();

                 clearSelectionUI(timeSlotsContainer);

                if (!Array.isArray(availableSlots)) {
                     throw new Error("بيانات فترات الوقت المستلمة من الخادم غير صالحة."); // Translate message
                 }

                if (availableSlots.length === 0) {
                    displayMessage(timeSlotsContainer, 'لا توجد فترات زمنية متاحة في هذا التاريخ.'); // Translate message
                    return false;
                } else {
                     let timeActuallySelected = false;
                     availableSlots.forEach(time => {
                         const card = document.createElement('button');
                         card.type = 'button'; card.classList.add('slot-card');
                         card.dataset.time = time; card.textContent = time; // Keep time format as is from backend
                         card.addEventListener('click', () => handleTimeClick(time));
                         if (timeToSelect && time === timeToSelect) {
                             card.classList.add('selected');
                             selectedTime = time;
                             selectedTimeInput.value = time;
                             timeActuallySelected = true;
                         }
                         timeSlotsContainer.appendChild(card);
                     });
                    updateButtonState();
                     return true;
                 }
             } catch (error) {
                 console.error('Error fetching/displaying slots:', error);
                 // Translate message prefix
                 displayMessage(timeSlotsContainer, `خطأ في تحميل الأوقات: ${error.message}`, 'error');
                 timeSelectionGroup.style.display = 'block';
                 return false;
             }
         }

        function handleTimeClick(time) {
            selectedTime = time; selectedTimeInput.value = time;
             document.querySelectorAll('#timeSlotsContainer .slot-card').forEach(card => { card.classList.toggle('selected', card.dataset.time === time); });
             updateButtonState();
         }

        async function findAndSelectNearestSlot() {
             if (isFindingNearest) return;
             isFindingNearest = true;
            findNearestBtn.disabled = true;
             findNearestBtn.innerHTML = buttonTexts.findNearestSearching; // Use translated searching text
             findNearestStatus.textContent = 'جاري التحقق من التوفر...'; // Translate status message

            selectedMonthYear = null; selectedDate = null; selectedTime = null;
             selectedDateInput.value = ''; selectedTimeInput.value = '';
             timeSelectionGroup.style.display = 'none'; daySelectionGroup.style.display = 'none';
             document.querySelectorAll('.slot-card.selected').forEach(c => c.classList.remove('selected'));
             updateButtonState();

             try {
                const response = await fetch(`/get-nearest-available/${doctorId}`);
                if (!response.ok) {
                    // Translate default error
                    let errorMsg = 'تعذر العثور على أقرب فترة متاحة.';
                    try { const errorData = await response.json(); errorMsg = errorData.message || errorMsg; } catch (_) {}
                    throw new Error(errorMsg);
                }
                 const result = await response.json();

                 if (result.success && result.date && result.time) {
                     const nearestDate = result.date;
                     const nearestTime = result.time;
                     // Translate status message
                     findNearestStatus.textContent = `وجد: ${formatDateForDisplay(nearestDate)} في ${nearestTime}. جاري التحديد...`;

                    selectedDate = nearestDate; selectedTime = nearestTime;
                    selectedDateInput.value = nearestDate; selectedTimeInput.value = nearestTime;
                    selectedMonthYear = nearestDate.substring(0, 7);

                    const monthCard = monthSlotsContainer.querySelector(`.slot-card[data-month-year="${selectedMonthYear}"]`);
                     if (monthCard) {
                         monthCard.classList.add('selected');
                     } else {
                         generateMonthCards();
                         monthSlotsContainer.querySelector(`.slot-card[data-month-year="${selectedMonthYear}"]`)?.classList.add('selected');
                     }

                     daySelectionGroup.style.display = 'block';
                     generateDayCards(selectedMonthYear);
                     await new Promise(resolve => setTimeout(resolve, 50));
                     const dayCard = daySlotsContainer.querySelector(`.slot-card[data-date="${selectedDate}"]`);
                     if (dayCard) dayCard.classList.add('selected');

                     timeSelectionGroup.style.display = 'block';
                     await fetchAndDisplayTimeSlots(selectedDate, selectedTime);

                    updateButtonState();
                     // Translate final status message
                     findNearestStatus.textContent = `تم التحديد: ${formatDateForDisplay(selectedDate)} في ${selectedTime}.`;

                    setTimeout(() => {
                        const timeGroup = document.getElementById('timeSelectionGroup');
                        if(timeGroup) timeGroup.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }, 200);

                 } else {
                    // Translate error message
                     throw new Error(result.message || 'لم يتم العثور على فترات متاحة في المستقبل القريب.');
                }
             } catch (error) {
                console.error("Error finding/selecting nearest slot:", error);
                findNearestStatus.textContent = `خطأ: ${error.message}`; // Translate prefix
                // Translate error message in slots container
                 displayMessage(daySlotsContainer, `تعذر العثور على فترة قريبة: ${error.message}`, 'error');
                 daySelectionGroup.style.display = 'block';
             } finally {
                isFindingNearest = false;
                 findNearestBtn.disabled = false;
                findNearestBtn.innerHTML = buttonTexts.findNearestDefault; // Use translated default button text
                 setTimeout(() => { if (!isFindingNearest) findNearestStatus.textContent = ''; }, 5000);
            }
        }

         function formatDateForDisplay(dateString) {
            try {
                 const currentLocale = document.documentElement.lang || 'ar';
                 const date = new Date(dateString + 'T00:00:00Z'); // Use UTC to avoid timezone issues
                 return date.toLocaleDateString(currentLocale, {
                     weekday: 'short', year: 'numeric', month: 'short', day: 'numeric', timeZone: 'UTC'
                 });
             } catch { return dateString; }
         }

        // --- Event Listeners Setup ---
         document.addEventListener('DOMContentLoaded', () => {
            if(findNearestBtn) findNearestBtn.addEventListener('click', findAndSelectNearestSlot);
            selectedMonthYear = null; selectedDate = null; selectedTime = null;
            selectedDateInput.value = ''; selectedTimeInput.value = '';
            daySelectionGroup.style.display = 'none'; timeSelectionGroup.style.display = 'none';

            // Generate initial month view (may show loading message initially)
            // Display temporary loading message for months before generation starts
            displayMessage(monthSlotsContainer, '<i class="fas fa-spinner fa-spin"></i> جاري تحميل الأشهر...', 'loading');
             generateMonthCards(); // This will replace the loading message if successful

             // Set initial messages for day/time selection areas (translated)
             displayMessage(daySlotsContainer, 'الرجاء اختيار شهر أولاً. <i class="fas fa-mouse-pointer"></i>');
             displayMessage(timeSlotsContainer, 'الرجاء اختيار يوم أولاً. <i class="fas fa-mouse-pointer"></i>');
             // Set initial button state (using translated default text)
             updateButtonState();
             hideFlashMessages();

            // --- FingerprintJS Logic (Unchanged) ---
             if (typeof FingerprintJS === 'undefined') {
                console.warn('FingerprintJS library not loaded yet or failed to load.');
             } else {
                FingerprintJS.load()
                    .then(fp => fp.get())
                    .then(result => {
                        const fpInput = document.getElementById('fingerprint-input');
                        if (fpInput) {
                            fpInput.value = result.visitorId;
                             console.log("Device Fingerprint ID set:", result.visitorId);
                        } else { console.warn('Fingerprint input element not found.'); }
                    })
                     .catch(error => console.error('FingerprintJS Error:', error));
             }
         });

         // --- Flash Message Handling (Animation Start/End Adjusted via CSS override) ---
         function hideFlashMessages() {
             const flashMessages = document.querySelectorAll('.flash-message');
             flashMessages.forEach(message => {
                 // Ensure animation starts correctly based on CSS definition for the current dir
                requestAnimationFrame(() => { message.style.opacity = '1'; message.style.transform = 'translateX(0)'; });
                 // Timeout logic remains the same
                const fadeOutTimer = setTimeout(() => {
                     // Use the end state defined in the RTL/LTR animation
                    message.style.opacity = '0';
                     if(document.documentElement.dir === 'rtl') {
                        message.style.transform = 'translateX(-100%)'; // Slide out LEFT for RTL
                    } else {
                         message.style.transform = 'translateX(100%)'; // Slide out RIGHT for LTR
                     }
                    const removeTimer = setTimeout(() => message.remove(), 500);
                 }, 4500);

                 message.addEventListener('mouseover', () => clearTimeout(fadeOutTimer));
                // mouseout listener removed as it can be buggy
            });
        }
    </script>

</body>
</html>